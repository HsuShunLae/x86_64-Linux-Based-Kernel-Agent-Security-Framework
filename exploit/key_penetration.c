#define _GNU_SOURCE
#include <sys/ptrace.h>
#include <sys/wait.h>
#include <sys/user.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

/*
 * Safe ptrace-based syscall injection demo.
 *
 */

static void inject_keyctl(pid_t pid) {
    struct user_regs_struct regs, saved;

    /* Save current register state */
    ptrace(PTRACE_GETREGS, pid, 0, &regs);
    saved = regs;

    fprintf(stderr,
        "[INJECT] Injecting simulated keyctl syscall\n"
        "[SIM] CVE-style pattern: over-privileged assumption\n"
    );


    regs.orig_rax = SYS_keyctl;
    regs.rax      = SYS_keyctl;
    regs.rdi      = 7;   /* KEYCTL_CLEAR */
    regs.rsi      = 0;
    regs.rdx      = 0;
    regs.r10      = 0;
    regs.r8       = 0;
    regs.r9       = 0;

    /* Install registers */
    ptrace(PTRACE_SETREGS, pid, 0, &regs);

    /* Execute injected syscall */
    ptrace(PTRACE_SYSCALL, pid, 0, 0);
    waitpid(pid, NULL, 0);

    /* Restore original state */
    ptrace(PTRACE_SETREGS, pid, 0, &saved);

    fprintf(stderr,
        "[INJECT] keyctl syscall completed\n"
    );
}

int main(int argc, char *argv[]) {
    if (argc < 2) {
        fprintf(stderr, "Usage: %s <program> [args...]\n", argv[0]);
        return 1;
    }

    pid_t child = fork();

    if (child == 0) {
        /* Child: allow tracing */
        ptrace(PTRACE_TRACEME, 0, 0, 0);
        execvp(argv[1], &argv[1]);
        perror("execvp");
        _exit(1);
    }

    int status;

    /* Parent: wait for execve stop */
    waitpid(child, &status, 0);

    /*
     * Let the program execute its FIRST syscall
     */
    ptrace(PTRACE_SYSCALL, child, 0, 0);
    waitpid(child, &status, 0);

    /*
     * Let that syscall EXIT
     */
    ptrace(PTRACE_SYSCALL, child, 0, 0);
    waitpid(child, &status, 0);

    /*
     * Inject simulated keyctl AFTER startup
     */
    inject_keyctl(child);

    /*
     * Resume normal execution
     */
    ptrace(PTRACE_CONT, child, 0, 0);
    waitpid(child, &status, 0);

    fprintf(stderr,
        "[DONE] Program completed with simulated keyctl exposure\n"
    );

    return 0;
}

